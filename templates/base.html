<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="format-detection" content="telephone=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>{% block title %}AI Banking Assistant for Azerbaijan{% endblock %}</title>
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Favicon - Complete Setup -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='/favicon_io/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', path='/favicon_io/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', path='/favicon_io/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', path='/favicon_io/site.webmanifest') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='/favicon_io/favicon.ico') }}">
    
    <!-- Meta tags for better mobile experience -->
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Banking Assistant">
    <meta name="msapplication-TileColor" content="#1f4e79">
    <meta name="description" content="AI-powered banking assistant for Azerbaijan with real-time loan comparison, branch finder, and currency rates">
    <meta name="keywords" content="Azerbaijan banks, loan comparison, bank branches, currency rates, PASHA Bank, Kapital Bank">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="AI Banking Assistant for Azerbaijan">
    <meta property="og:description" content="Free loan comparison, branch finder, and AI-powered banking help">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ url_for('static', path='/favicon_io/android-chrome-512x512.png') }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-9ndCyUa6J7bCNEaGamhb6yp/Dh8JA5/w6rIwlj5zv7ZdRXIBVrPHRG6MJ6CuH1zQ" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', path='/css/styles.css') }}" rel="stylesheet">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js" 
            integrity="sha384-mlJfT1j9EiWZXiJj2wAo2jVPmRzl8JM9wPmAJzjKKUq3T9S9k3nQ8pLjF7xY7BgN" crossorigin="anonymous"></script>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ url_for('static', path='/css/styles.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', path='/js/app.js') }}" as="script">
    
    {% block extra_head %}{% endblock %}
    
    <!-- Initialize viewport height variable for mobile -->
    <script>
        document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    </script>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a class="skip-link" href="#main-content">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/" aria-label="AI Banking Assistant Home">
                <i class="bi bi-bank2 me-2"></i>
                <span class="d-none d-sm-inline">AI Banking Assistant</span>
                <span class="d-sm-none">Banking</span>
            </a>
            
            <button class="navbar-toggler" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#navbarNav"
                    aria-controls="navbarNav" 
                    aria-expanded="false" 
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/" aria-label="Home page">
                            <i class="bi bi-house me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/loans" aria-label="Loan comparison">
                            <i class="bi bi-currency-dollar me-1"></i>Loans
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/branches" aria-label="Find bank branches">
                            <i class="bi bi-geo-alt me-1"></i>Branches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/currency" aria-label="Currency exchange rates">
                            <i class="bi bi-currency-exchange me-1"></i>Currency
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat" aria-label="AI chat assistant">
                            <i class="bi bi-chat-dots me-1"></i>AI Chat
                        </a>
                    </li>
                </ul>
                
                <!-- Real-time Data Indicator -->
                <div class="navbar-text d-none d-md-block">
                    <div id="dataSourceIndicator" class="d-flex align-items-center">
                        <div class="status-indicator bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                        <small>Real-time Data</small>
                    </div>
                </div>
                
                <!-- Language Selector -->
                <div class="dropdown ms-3">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" 
                            type="button" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false"
                            aria-label="Select language">
                        <i class="bi bi-translate me-1"></i>
                        <span id="currentLanguage">EN</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('en')" role="button">ðŸ‡ºðŸ‡¸ English</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('az')" role="button">ðŸ‡¦ðŸ‡¿ AzÉ™rbaycan</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Alert Container -->
    <div id="alertContainer" class="container mt-3" role="alert" aria-live="polite"></div>

    <!-- Main Content -->
    <main id="main-content" tabindex="-1">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-lg-3 mb-3">
                    <h6>AI Banking Assistant</h6>
                    <p class="text-muted small">Free banking information and AI assistance for Azerbaijan</p>
                    <div class="d-flex gap-2">
                        <a href="#" class="text-muted" aria-label="Privacy Policy">Privacy</a>
                        <a href="#" class="text-muted" aria-label="Terms of Service">Terms</a>
                        <a href="#" class="text-muted" aria-label="Contact us">Contact</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled small">
                        <li><a href="/loans" class="text-muted text-decoration-none">Compare Loans</a></li>
                        <li><a href="/branches" class="text-muted text-decoration-none">Find Branches</a></li>
                        <li><a href="/currency" class="text-muted text-decoration-none">Currency Rates</a></li>
                        <li><a href="/chat" class="text-muted text-decoration-none">AI Assistant</a></li>
                    </ul>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                    <h6>Features</h6>
                    <ul class="list-unstyled small">
                        <li><span class="text-muted">âœ“ 100% Free Service</span></li>
                        <li><span class="text-muted">âœ“ No Registration Required</span></li>
                        <li><span class="text-muted">âœ“ Real-time Banking Data</span></li>
                        <li><span class="text-muted">âœ“ AI-Powered Assistance</span></li>
                    </ul>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                    <h6>System Status</h6>
                    <div id="systemStatus" class="small">
                        <div id="mcpStatus" class="mb-1">
                            <i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i>
                            <span class="ms-1">MCP Connected</span>
                        </div>
                        <div id="aiStatus" class="mb-1">
                            <i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i>
                            <span class="ms-1">AI Online</span>
                        </div>
                        <div id="dbStatus" class="mb-1">
                            <i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i>
                            <span class="ms-1">Database OK</span>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="text-muted">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">Â© 2024 AI Banking Assistant. Open source project under MIT License.</small>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        <span id="lastUpdated">Updated: <span id="updateTime">Loading...</span></span>
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="loadingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0" id="loadingText">Processing your request...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="position-fixed bottom-0 start-0 end-0 bg-warning text-dark text-center p-2 d-none" style="z-index: 1060;">
        <i class="bi bi-wifi-off me-2"></i>
        You are offline. Some features may not work properly.
    </div>

    <!-- Install App Prompt (will be added dynamically) -->
    <div id="installPrompt"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>
    
    {% block extra_js %}{% endblock %}

    <!-- Initialize App -->
    <script>
        // Global variables
        let currentLanguage = localStorage.getItem('language') || 'en';
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            updateLanguageText();
            updateLastUpdated();
            
            // Check system status periodically
            setInterval(checkSystemStatus, 60000); // Every minute
            setInterval(updateLastUpdated, 30000); // Every 30 seconds
        });
        
        // Check system status with improved error handling
        async function checkSystemStatus() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('/api/health', {
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const status = await response.json();
                updateSystemStatusUI(status);
                
            } catch (error) {
                console.error('System status check failed:', error);
                updateSystemStatusUI(null, error);
            }
        }
        
        // Update system status UI
        function updateSystemStatusUI(status, error = null) {
            const mcpStatus = document.getElementById('mcpStatus');
            const aiStatus = document.getElementById('aiStatus');
            const dbStatus = document.getElementById('dbStatus');
            const dataIndicator = document.getElementById('dataSourceIndicator');
            
            if (error || !status) {
                // Show offline status
                mcpStatus.innerHTML = '<i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i><span class="ms-1">System Offline</span>';
                aiStatus.innerHTML = '<i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i><span class="ms-1">AI Offline</span>';
                dbStatus.innerHTML = '<i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i><span class="ms-1">Database Error</span>';
                
                if (dataIndicator) {
                    dataIndicator.innerHTML = '<div class="status-indicator bg-danger rounded-circle me-2" style="width: 8px; height: 8px;"></div><small>System Offline</small>';
                }
                return;
            }
            
            // Update MCP status
            if (status.mcp_client === 'connected') {
                mcpStatus.innerHTML = '<i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i><span class="ms-1">MCP Connected</span>';
                if (dataIndicator) {
                    dataIndicator.innerHTML = '<div class="status-indicator bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div><small>Real-time Data</small>';
                }
            } else {
                mcpStatus.innerHTML = '<i class="bi bi-circle-fill text-warning" style="font-size: 8px;"></i><span class="ms-1">MCP Fallback</span>';
                if (dataIndicator) {
                    dataIndicator.innerHTML = '<div class="status-indicator bg-warning rounded-circle me-2" style="width: 8px; height: 8px;"></div><small>Database Mode</small>';
                }
            }
            
            // Update AI status
            if (status.ai_model === 'available') {
                aiStatus.innerHTML = '<i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i><span class="ms-1">AI Online</span>';
            } else {
                aiStatus.innerHTML = '<i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i><span class="ms-1">AI Offline</span>';
            }
            
            // Update Database status
            if (status.database === 'connected') {
                dbStatus.innerHTML = '<i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i><span class="ms-1">Database OK</span>';
            } else {
                dbStatus.innerHTML = '<i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i><span class="ms-1">Database Error</span>';
            }
        }
        
        // Language management with persistence
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.getElementById('currentLanguage').textContent = lang.toUpperCase();
            updateLanguageText();
            
            // Update document language attribute
            document.documentElement.lang = lang === 'az' ? 'az' : 'en';
            
            // Trigger language change event for page-specific updates
            document.dispatchEvent(new CustomEvent('languageChanged', { 
                detail: { language: lang } 
            }));
        }
        
        function updateLanguageText() {
            // Update current language display
            document.getElementById('currentLanguage').textContent = currentLanguage.toUpperCase();
            
            // Update document language
            document.documentElement.lang = currentLanguage === 'az' ? 'az' : 'en';
        }
        
        // Update last updated timestamp
        function updateLastUpdated() {
            const updateTime = document.getElementById('updateTime');
            if (updateTime) {
                updateTime.textContent = new Date().toLocaleTimeString();
            }
        }
        
        // Network status monitoring
        window.addEventListener('online', function() {
            document.getElementById('offlineIndicator').classList.add('d-none');
            checkSystemStatus(); // Immediately check status when back online
        });
        
        window.addEventListener('offline', function() {
            document.getElementById('offlineIndicator').classList.remove('d-none');
        });
        
        // Handle orientation changes for mobile
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                // Recalculate viewport height
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            }, 500);
        });
        
        // Accessibility improvements
        document.addEventListener('keydown', function(e) {
            // Escape key closes modals
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    const modal = bootstrap.Modal.getInstance(openModal);
                    if (modal) modal.hide();
                }
            }
        });
        
        // Initialize language on load
        setLanguage(currentLanguage);
    </script>
</body>
</html>