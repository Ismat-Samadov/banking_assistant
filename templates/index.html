{% extends "base.html" %}

{% block title %}Banking AI Assistant - Chat{% endblock %}
{% block page_name %}chat{% endblock %}

{% block content %}
<div class="chat-app-container">
    <!-- Welcome Section -->
    <div class="welcome-section bg-gradient-primary text-white py-5">
        <div class="container">
            <div class="row align-items-center justify-content-center text-center">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <i class="bi bi-robot display-4 mb-3"></i>
                        <h1 class="display-5 fw-bold mb-3">Banking AI Assistant</h1>
                        <p class="lead mb-4 opacity-90">
                            Get instant help with banking questions, financial advice, and more. 
                            Ask me anything about banking services in Azerbaijan!
                        </p>
                    </div>
                    
                    <!-- Quick Features -->
                    <div class="row g-3 justify-content-center">
                        <div class="col-auto">
                            <span class="badge bg-white bg-opacity-25 text-white px-3 py-2">
                                <i class="bi bi-bank me-1"></i>
                                Account Services
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-white bg-opacity-25 text-white px-3 py-2">
                                <i class="bi bi-currency-exchange me-1"></i>
                                Currency Rates
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-white bg-opacity-25 text-white px-3 py-2">
                                <i class="bi bi-geo-alt me-1"></i>
                                ATM Locations
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-white bg-opacity-25 text-white px-3 py-2">
                                <i class="bi bi-graph-up me-1"></i>
                                Financial Tips
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <!-- Chat Container -->
                <div class="chat-container shadow-lg">
                    <!-- Chat Header -->
                    <div class="chat-header bg-white">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3">
                                    <i class="bi bi-robot"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 text-primary fw-bold">Banking Assistant</h5>
                                    <small class="text-muted">
                                        <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.6rem;"></i>
                                        Online â€¢ Ready to help
                                    </small>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="clearChat()" title="Clear chat">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary rounded-pill ms-2" onclick="downloadChat()" title="Download chat">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-messages" id="chat-messages">
                        <!-- Welcome Message -->
                        <div class="message bot-message">
                            <div class="message-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <p class="mb-2">ðŸ‘‹ <strong>Welcome to Banking AI Assistant!</strong></p>
                                    <p class="mb-2">I'm here to help you with:</p>
                                    <ul class="mb-2">
                                        <li>Banking services and account information</li>
                                        <li>Financial planning and budgeting tips</li>
                                        <li>Currency exchange rates</li>
                                        <li>ATM and branch locations</li>
                                        <li>Digital banking guidance</li>
                                    </ul>
                                    <p class="mb-0">
                                        <strong>How can I assist you today?</strong> 
                                        Feel free to ask me anything about banking!
                                    </p>
                                </div>
                                <div class="message-time">
                                    <small class="text-muted">Just now</small>
                                </div>
                            </div>
                        </div>

                        <!-- Typing Indicator -->
                        <div class="message bot-message typing-indicator" id="typing-indicator" style="display: none;">
                            <div class="message-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="typing-animation">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input-container bg-white">
                        <form id="chat-form" class="d-flex align-items-end gap-3">
                            <div class="flex-grow-1">
                                <textarea 
                                    id="message-input" 
                                    class="form-control border-2" 
                                    placeholder="Type your banking question here... (e.g., 'How do I open a savings account?')"
                                    rows="1"
                                    maxlength="1000"
                                    required
                                ></textarea>
                                <div class="chat-input-footer">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Press Enter to send, Shift+Enter for new line
                                    </small>
                                    <span class="text-muted" style="font-size: 0.75rem;">
                                        <span id="char-count">0</span>/1000
                                    </span>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill px-4" id="send-button">
                                <i class="bi bi-send"></i>
                                <span class="d-none d-sm-inline ms-1">Send</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chat functionality
let chatHistory = [];
let isTyping = false;

// DOM elements
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const typingIndicator = document.getElementById('typing-indicator');
const sendButton = document.getElementById('send-button');
const charCount = document.getElementById('char-count');

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    setupEventListeners();
    
    // Auto-resize textarea
    autoResizeTextarea(messageInput);
    
    // Focus on input
    messageInput.focus();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    chatForm.addEventListener('submit', handleFormSubmit);
    
    // Textarea auto-resize and character count
    messageInput.addEventListener('input', function() {
        autoResizeTextarea(this);
        updateCharCount();
    });
    
    // Enter key handling
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleFormSubmit(e);
        }
    });
}

// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Update character count
function updateCharCount() {
    const count = messageInput.value.length;
    charCount.textContent = count;
    
    if (count > 900) {
        charCount.className = 'text-danger';
    } else if (count > 800) {
        charCount.className = 'text-warning';
    } else {
        charCount.className = 'text-muted';
    }
}

// Handle form submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message || isTyping) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input and reset height
    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateCharCount();
    
    // Show typing indicator
    showTyping();
    
    try {
        const response = await sendMessage(message);
        hideTyping();
        addMessage(response.response, 'bot');
    } catch (error) {
        hideTyping();
        addMessage('Sorry, I\'m having trouble connecting right now. Please try again in a moment.', 'bot', true);
        console.error('Chat error:', error);
    }
}

// Send message to API
async function sendMessage(message) {
    const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: getSessionId()
        })
    });
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }
    
    return await response.json();
}

// Add message to chat
function addMessage(content, sender, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message ${isError ? 'error-message' : ''}`;
    
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-${sender === 'user' ? 'person-circle' : 'robot'}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${formatMessageContent(content)}
            </div>
            <div class="message-time">
                <small class="text-muted">${timestamp}</small>
            </div>
        </div>
    `;
    
    // Insert before typing indicator
    chatMessages.insertBefore(messageDiv, typingIndicator);
    
    // Add to history
    chatHistory.push({
        content: content,
        sender: sender,
        timestamp: new Date().toISOString(),
        isError: isError
    });
    
    // Save to localStorage
    saveChatHistory();
    
    // Scroll to bottom
    scrollToBottom();
}

// Format message content (support for basic markdown-like formatting)
function formatMessageContent(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
}

// Show typing indicator
function showTyping() {
    isTyping = true;
    typingIndicator.style.display = 'block';
    sendButton.disabled = true;
    scrollToBottom();
}

// Hide typing indicator
function hideTyping() {
    isTyping = false;
    typingIndicator.style.display = 'none';
    sendButton.disabled = false;
}

// Scroll to bottom of chat
function scrollToBottom() {
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// Chat management functions
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        chatHistory = [];
        
        // Clear messages except welcome message
        const messages = chatMessages.querySelectorAll('.message:not(:first-child):not(#typing-indicator)');
        messages.forEach(msg => msg.remove());
        
        localStorage.removeItem('banking_chat_history');
        
        // Focus back on input
        messageInput.focus();
    }
}

function downloadChat() {
    if (chatHistory.length === 0) {
        alert('No chat history to download.');
        return;
    }
    
    const chatText = chatHistory.map(msg => {
        const time = new Date(msg.timestamp).toLocaleString();
        return `[${time}] ${msg.sender.toUpperCase()}: ${msg.content}`;
    }).join('\n\n');
    
    const blob = new Blob([chatText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `banking-chat-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Utility functions
function getSessionId() {
    let sessionId = sessionStorage.getItem('banking_session_id');
    if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('banking_session_id', sessionId);
    }
    return sessionId;
}

function saveChatHistory() {
    try {
        localStorage.setItem('banking_chat_history', JSON.stringify(chatHistory));
    } catch (e) {
        console.warn('Could not save chat history:', e);
    }
}

function loadChatHistory() {
    try {
        const saved = localStorage.getItem('banking_chat_history');
        if (saved) {
            chatHistory = JSON.parse(saved);
            
            // Restore messages (skip welcome message)
            chatHistory.forEach(msg => {
                if (!msg.isWelcome) {
                    addMessageToDOM(msg.content, msg.sender, msg.isError, msg.timestamp);
                }
            });
        }
    } catch (e) {
        console.warn('Could not load chat history:', e);
        chatHistory = [];
    }
}

function addMessageToDOM(content, sender, isError, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message ${isError ? 'error-message' : ''}`;
    
    const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-${sender === 'user' ? 'person-circle' : 'robot'}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${formatMessageContent(content)}
            </div>
            <div class="message-time">
                <small class="text-muted">${time}</small>
            </div>
        </div>
    `;
    
    chatMessages.insertBefore(messageDiv, typingIndicator);
}
</script>
{% endblock %}