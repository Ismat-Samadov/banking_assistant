<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>{% block title %}Banking AI Assistant{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', path='favicon_io/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', path='favicon_io/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='favicon_io/apple-touch-icon.png') }}">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" as="style">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', path='css/styles.css') }}" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', path='favicon_io/site.webmanifest') }}">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="AI-powered banking location finder and currency intelligence for Azerbaijan. Find branches, ATMs, and get real-time currency rates.">
    <meta name="keywords" content="Azerbaijan, banking, ATM, branches, currency, exchange rates, AI assistant">
    <meta name="author" content="Banking AI Assistant">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}Banking AI Assistant{% endblock %}">
    <meta property="og:description" content="AI-powered banking location & currency intelligence for Azerbaijan">
    <meta property="og:type" content="website">
    <meta property="og:image" content="{{ url_for('static', path='favicon_io/android-chrome-512x512.png') }}">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Banking AI Assistant{% endblock %}">
    <meta name="twitter:description" content="AI-powered banking location & currency intelligence for Azerbaijan">
    
    <!-- Theme Color for Mobile Browsers (Light Mode Only) -->
    <meta name="theme-color" content="#1f4e79">
    
    <!-- Prevent zoom on form focus for iOS -->
    <meta name="format-detection" content="telephone=no">
    
    {% block extra_head %}{% endblock %}
</head>
<body data-page="{% block page_name %}{% endblock %}">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" role="navigation" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/" aria-label="Banking AI Assistant Home">
                <i class="bi bi-bank me-2" aria-hidden="true"></i>
                <span class="fw-bold">Banking AI</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/locations' %}active{% endif %}" 
                           href="/locations" aria-label="Find bank locations">
                            <i class="bi bi-geo-alt me-1" aria-hidden="true"></i>Locations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/currency' %}active{% endif %}" 
                           href="/currency" aria-label="Currency exchange rates">
                            <i class="bi bi-currency-exchange me-1" aria-hidden="true"></i>Currency
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.url.path == '/chat' %}active{% endif %}" 
                           href="/chat" aria-label="AI chat assistant">
                            <i class="bi bi-chat-dots me-1" aria-hidden="true"></i>AI Chat
                        </a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    <!-- Language Dropdown -->
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-label="Select language">
                            <i class="bi bi-globe me-1" aria-hidden="true"></i>
                            <span id="currentLanguage">EN</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('en')" data-lang="en">English</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('az')" data-lang="az">Az…ôrbaycan</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="alert alert-warning alert-dismissible fade d-none" role="alert" 
         style="margin-top: 76px; margin-bottom: 0; border-radius: 0;">
        <div class="container">
            <div class="d-flex align-items-center">
                <i class="bi bi-wifi-off me-2" aria-hidden="true"></i>
                <span>You're offline. Some features may not work properly.</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content" id="main-content" role="main">
        <!-- Alert Container for Dynamic Notifications -->
        <div id="alertContainer" class="container mt-3" role="alert" aria-live="polite" aria-atomic="true"></div>
        
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5" role="contentinfo">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold text-primary">Banking AI Assistant</h6>
                    <p class="text-muted small mb-0">AI-powered banking location & currency intelligence for Azerbaijan</p>
                    <p class="text-muted small mb-0">
                        <span id="app-version">v1.0.0</span> | 
                        <span id="last-updated">Updated: <span id="update-time"></span></span>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end gap-3 flex-wrap">
                        <a href="/api/health" target="_blank" rel="noopener" 
                           class="text-decoration-none" aria-label="Check system status">
                            <i class="bi bi-activity me-1" aria-hidden="true"></i>Status
                        </a>
                        <button class="btn btn-link p-0 text-decoration-none" onclick="showAccessibilityInfo()" 
                                aria-label="Accessibility information">
                            <i class="bi bi-universal-access me-1" aria-hidden="true"></i>Accessibility
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true" 
         aria-labelledby="loadingModalLabel">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>
                    <div id="loadingText" aria-live="polite">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Accessibility Info Modal -->
    <div class="modal fade" id="accessibilityModal" tabindex="-1" aria-hidden="true" 
         aria-labelledby="accessibilityModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accessibilityModalLabel">
                        <i class="bi bi-universal-access me-2"></i>Accessibility Features
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Available Features:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-keyboard me-2 text-primary"></i>
                            <strong>Keyboard Navigation:</strong> Navigate using Tab, Enter, and arrow keys
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-eye me-2 text-primary"></i>
                            <strong>Screen Reader:</strong> Full ARIA labels and semantic markup
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-zoom-in me-2 text-primary"></i>
                            <strong>Zoom Support:</strong> Up to 500% zoom without loss of functionality
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-phone me-2 text-primary"></i>
                            <strong>Mobile Friendly:</strong> Responsive design for all devices
                        </li>
                    </ul>
                    
                    <h6 class="mt-4">Keyboard Shortcuts:</h6>
                    <ul class="list-unstyled">
                        <li><kbd>Alt + H</kbd> - Go to home page</li>
                        <li><kbd>Alt + L</kbd> - Go to locations page</li>
                        <li><kbd>Alt + C</kbd> - Go to currency page</li>
                        <li><kbd>Alt + A</kbd> - Go to AI chat</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Connection status monitoring
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                if (indicator && !indicator.classList.contains('d-none')) {
                    indicator.classList.add('d-none');
                }
            } else {
                if (indicator) {
                    indicator.classList.remove('d-none');
                    indicator.classList.add('show');
                }
            }
        }
        
        // Accessibility functions
        function showAccessibilityInfo() {
            const modal = new bootstrap.Modal(document.getElementById('accessibilityModal'));
            modal.show();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.altKey) {
                switch(e.key.toLowerCase()) {
                    case 'h':
                        e.preventDefault();
                        window.location.href = '/';
                        break;
                    case 'l':
                        e.preventDefault();
                        window.location.href = '/locations';
                        break;
                    case 'c':
                        e.preventDefault();
                        window.location.href = '/currency';
                        break;
                    case 'a':
                        e.preventDefault();
                        window.location.href = '/chat';
                        break;
                }
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus();
            
            // Set update time in footer
            const updateTimeEl = document.getElementById('update-time');
            if (updateTimeEl) {
                updateTimeEl.textContent = new Date().toLocaleString();
            }
            
            // Add active navigation highlighting
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
        
        // Event listeners
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // Language management
        window.setLanguage = function(lang) {
            localStorage.setItem('language', lang);
            
            const currentLangEl = document.getElementById('currentLanguage');
            if (currentLangEl) {
                currentLangEl.textContent = lang.toUpperCase();
            }
            
            // Update active language in dropdown
            document.querySelectorAll('.dropdown-item[data-lang]').forEach(item => {
                if (item.dataset.lang === lang) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Dispatch language change event
            document.dispatchEvent(new CustomEvent('languageChanged', { 
                detail: { language: lang } 
            }));
        };
        
        // Load saved language
        const savedLanguage = localStorage.getItem('language') || 'en';
        if (savedLanguage !== 'en') {
            setLanguage(savedLanguage);
        }
        
        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // Global error handler for better user experience
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            
            // Show user-friendly error message
            const alertContainer = document.getElementById('alertContainer');
            if (alertContainer) {
                const alertHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Something went wrong. Please refresh the page or try again later.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            }
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e);
            e.preventDefault(); // Prevent the default browser behavior
        });
        
        // Expose global functions
        window.showAccessibilityInfo = showAccessibilityInfo;
    </script>
    
    <!-- Custom App Script -->
    <script src="{{ url_for('static', path='js/app.js') }}"></script>
    
    <!-- Page-specific scripts -->
    {% block extra_scripts %}{% endblock %}
</body>
</html>