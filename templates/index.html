{% extends "base.html" %}

{% block title %}Banking AI Assistant - Chat{% endblock %}
{% block page_name %}chat{% endblock %}

{% block content %}
<div class="chat-app-container">
    <!-- Welcome Section -->
    <div class="welcome-section bg-primary text-white py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-2">
                        <i class="bi bi-robot me-2"></i>
                        Banking AI Assistant
                    </h1>
                    <p class="mb-0 opacity-75">
                        Get instant help with banking questions, financial advice, and more. 
                        Ask me anything about banking in Azerbaijan!
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex align-items-center justify-content-md-end justify-content-start mt-3 mt-md-0">
                        <span class="badge bg-success me-2">
                            <i class="bi bi-circle-fill me-1" style="font-size: 0.6rem;"></i>
                            AI Ready
                        </span>
                        <span class="badge bg-light text-primary">
                            <i class="bi bi-translate me-1"></i>
                            AZ/EN
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions bg-light py-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-primary btn-sm w-100 quick-action-btn" 
                            onclick="sendQuickMessage('Tell me about opening a bank account')">
                        <i class="bi bi-bank me-1"></i>
                        <span class="d-none d-sm-inline">Bank</span> Account
                    </button>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-primary btn-sm w-100 quick-action-btn" 
                            onclick="sendQuickMessage('What are current USD exchange rates?')">
                        <i class="bi bi-currency-exchange me-1"></i>
                        <span class="d-none d-sm-inline">Currency</span> Rates
                    </button>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-primary btn-sm w-100 quick-action-btn" 
                            onclick="sendQuickMessage('How can I find ATMs near me?')">
                        <i class="bi bi-geo-alt me-1"></i>
                        <span class="d-none d-sm-inline">Find</span> ATMs
                    </button>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-primary btn-sm w-100 quick-action-btn" 
                            onclick="sendQuickMessage('Give me financial planning tips')">
                        <i class="bi bi-graph-up me-1"></i>
                        <span class="d-none d-sm-inline">Financial</span> Tips
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <!-- Chat Container -->
                <div class="chat-container">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3">
                                    <i class="bi bi-robot text-primary"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0">Banking Assistant</h5>
                                    <small class="text-muted">Always here to help</small>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()" title="Clear chat">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="downloadChat()" title="Download chat">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-messages" id="chat-messages">
                        <!-- Welcome Message -->
                        <div class="message bot-message">
                            <div class="message-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <p class="mb-2">ðŸ‘‹ <strong>Welcome to Banking AI Assistant!</strong></p>
                                    <p class="mb-2">I'm here to help you with:</p>
                                    <ul class="mb-2">
                                        <li>Banking services and account information</li>
                                        <li>Currency rates and financial advice</li>
                                        <li>Finding ATMs and branches</li>
                                        <li>Digital banking guidance</li>
                                    </ul>
                                    <p class="mb-0">What can I help you with today?</p>
                                </div>
                                <div class="message-time">
                                    <small class="text-muted">Just now</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <div class="message bot-message">
                            <div class="message-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="typing-animation">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-container">
                    <form id="chat-form" class="d-flex align-items-end">
                        <div class="input-group">
                            <textarea 
                                id="message-input" 
                                class="form-control" 
                                placeholder="Type your banking question here..."
                                rows="1"
                                maxlength="1000"
                                required
                            ></textarea>
                            <button type="submit" class="btn btn-primary" id="send-button">
                                <i class="bi bi-send"></i>
                                <span class="d-none d-sm-inline ms-1">Send</span>
                            </button>
                        </div>
                    </form>
                    <div class="chat-input-footer">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Press Enter to send, Shift+Enter for new line
                        </small>
                        <span class="text-muted" style="font-size: 0.75rem;">
                            <span id="char-count">0</span>/1000
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chat functionality
let chatHistory = [];
let isTyping = false;

// DOM elements
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const typingIndicator = document.getElementById('typing-indicator');
const sendButton = document.getElementById('send-button');
const charCount = document.getElementById('char-count');

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    setupEventListeners();
    
    // Auto-resize textarea
    autoResizeTextarea(messageInput);
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    chatForm.addEventListener('submit', handleFormSubmit);
    
    // Textarea auto-resize and character count
    messageInput.addEventListener('input', function() {
        autoResizeTextarea(this);
        updateCharCount();
    });
    
    // Enter key handling
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleFormSubmit(e);
        }
    });
}

// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Update character count
function updateCharCount() {
    const count = messageInput.value.length;
    charCount.textContent = count;
    
    if (count > 900) {
        charCount.className = 'text-danger';
    } else if (count > 800) {
        charCount.className = 'text-warning';
    } else {
        charCount.className = 'text-muted';
    }
}

// Handle form submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message || isTyping) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input and reset height
    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateCharCount();
    
    // Show typing indicator
    showTyping();
    
    try {
        const response = await sendMessage(message);
        hideTyping();
        addMessage(response.response, 'bot');
    } catch (error) {
        hideTyping();
        addMessage('Sorry, I\'m having trouble connecting right now. Please try again in a moment.', 'bot', true);
        console.error('Chat error:', error);
    }
}

// Send message to API
async function sendMessage(message) {
    const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: getSessionId()
        })
    });
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }
    
    return await response.json();
}

// Add message to chat
function addMessage(content, sender, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message ${isError ? 'error-message' : ''}`;
    
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-${sender === 'user' ? 'person-circle' : 'robot'}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${formatMessageContent(content)}
            </div>
            <div class="message-time">
                <small class="text-muted">${timestamp}</small>
            </div>
        </div>
    `;
    
    // Insert before typing indicator
    chatMessages.insertBefore(messageDiv, typingIndicator);
    
    // Add to history
    chatHistory.push({
        content: content,
        sender: sender,
        timestamp: new Date().toISOString(),
        isError: isError
    });
    
    // Save to localStorage
    saveChatHistory();
    
    // Scroll to bottom
    scrollToBottom();
}

// Format message content (support for basic markdown-like formatting)
function formatMessageContent(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
}

// Show typing indicator
function showTyping() {
    isTyping = true;
    typingIndicator.style.display = 'block';
    sendButton.disabled = true;
    scrollToBottom();
}

// Hide typing indicator
function hideTyping() {
    isTyping = false;
    typingIndicator.style.display = 'none';
    sendButton.disabled = false;
}

// Scroll to bottom of chat
function scrollToBottom() {
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// Quick message functions
function sendQuickMessage(message) {
    messageInput.value = message;
    handleFormSubmit(new Event('submit'));
}

// Chat management functions
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        chatHistory = [];
        chatMessages.innerHTML = `
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <p class="mb-0">Chat cleared! How can I help you today?</p>
                    </div>
                    <div class="message-time">
                        <small class="text-muted">Just now</small>
                    </div>
                </div>
            </div>
        `;
        saveChatHistory();
        showToast('Chat history cleared', 'success');
    }
}

function downloadChat() {
    if (chatHistory.length === 0) {
        showToast('No chat history to download', 'info');
        return;
    }
    
    const chatText = chatHistory.map(msg => 
        `[${new Date(msg.timestamp).toLocaleString()}] ${msg.sender.toUpperCase()}: ${msg.content}`
    ).join('\n\n');
    
    const blob = new Blob([chatText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `banking-chat-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Chat history downloaded', 'success');
}

// Session management
function getSessionId() {
    let sessionId = localStorage.getItem('chat_session_id');
    if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chat_session_id', sessionId);
    }
    return sessionId;
}

// Chat history persistence
function saveChatHistory() {
    try {
        localStorage.setItem('chat_history', JSON.stringify(chatHistory));
    } catch (e) {
        console.warn('Could not save chat history:', e);
    }
}

function loadChatHistory() {
    try {
        const saved = localStorage.getItem('chat_history');
        if (saved) {
            chatHistory = JSON.parse(saved);
            
            // Restore messages (skip the welcome message)
            chatHistory.forEach(msg => {
                if (msg.content && msg.sender) {
                    addMessageToDOM(msg.content, msg.sender, msg.isError || false, msg.timestamp);
                }
            });
            
            if (chatHistory.length > 0) {
                scrollToBottom();
            }
        }
    } catch (e) {
        console.warn('Could not load chat history:', e);
        chatHistory = [];
    }
}

function addMessageToDOM(content, sender, isError = false, timestamp = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message ${isError ? 'error-message' : ''}`;
    
    const timeString = timestamp ? 
        new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) :
        new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-${sender === 'user' ? 'person-circle' : 'robot'}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${formatMessageContent(content)}
            </div>
            <div class="message-time">
                <small class="text-muted">${timeString}</small>
            </div>
        </div>
    `;
    
    chatMessages.insertBefore(messageDiv, typingIndicator);
}

// Toast notification function (for better UX)
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}