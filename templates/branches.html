{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section text-center text-white py-4">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="bi bi-geo-alt me-3"></i>
                    Bank Branch Finder
                </h1>
                <p class="lead">Find the nearest bank branches with interactive maps and directions</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Search Form -->
        <div class="col-lg-4 mb-4">
            <div class="feature-card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="bi bi-search me-2"></i>
                        Find Branches
                    </h4>
                    
                    <form id="branchFinderForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="bank_name" class="form-label">Select Bank</label>
                            <select class="form-select" id="bank_name" name="bank_name">
                                <option value="all" selected>All Banks</option>
                                <option value="PASHA">PASHA Bank</option>
                                <option value="Kapital">Kapital Bank</option>
                                <option value="International">International Bank</option>
                                <option value="Access">AccessBank</option>
                                <option value="Rabite">RabiteBank</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" id="useMyLocation" class="btn btn-outline-primary">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    Use My Current Location
                                </button>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label for="latitude" class="form-label">Latitude</label>
                                    <input type="number" class="form-control" id="latitude" name="latitude" 
                                           value="40.4093" step="0.000001" required>
                                </div>
                                <div class="col-6">
                                    <label for="longitude" class="form-label">Longitude</label>
                                    <input type="number" class="form-control" id="longitude" name="longitude" 
                                           value="49.8671" step="0.000001" required>
                                </div>
                            </div>
                            <small class="text-muted">Default location: Baku city center</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-search me-2"></i>
                                Find Nearest Branches
                            </button>
                        </div>
                    </form>

                    <!-- Popular Locations -->
                    <div class="mt-4 pt-4 border-top">
                        <h6 class="text-muted mb-3">Popular Locations</h6>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setLocation(40.4093, 49.8671, 'Baku Center')">
                                <i class="bi bi-geo-alt me-1"></i>Baku Center
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setLocation(40.3777, 49.8531, 'PASHA Tower')">
                                <i class="bi bi-building me-1"></i>PASHA Tower Area
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setLocation(40.4037, 49.8682, 'Nizami Street')">
                                <i class="bi bi-shop me-1"></i>Nizami Street
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setLocation(40.3950, 49.8520, 'Elmlar Academy')">
                                <i class="bi bi-mortarboard me-1"></i>Elmlar Academy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Legend -->
            <div class="feature-card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        Bank Services
                    </h5>
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="bi bi-credit-card me-2 text-primary"></i>
                            ATM & Card Services
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-currency-exchange me-2 text-success"></i>
                            Currency Exchange
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-people me-2 text-info"></i>
                            Personal Banking
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-building me-2 text-warning"></i>
                            Business Banking
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-house me-2 text-danger"></i>
                            Mortgage Services
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Map and Results -->
        <div class="col-lg-8">
            <!-- Interactive Map -->
            <div class="map-container mb-4">
                <div id="branchMap" style="height: 400px; width: 100%;"></div>
            </div>

            <!-- Results Section -->
            <div id="branchResults">
                <!-- Default message -->
                <div class="text-center py-4">
                    <i class="bi bi-geo-alt display-1 text-muted mb-4"></i>
                    <h4 class="text-muted">Ready to Find Bank Branches</h4>
                    <p class="text-muted">
                        Use the search form to find the nearest bank branches in your area. 
                        Results will appear here with interactive map markers.
                    </p>
                    
                    <!-- Quick stats -->
                    <div class="row mt-4">
                        <div class="col-4">
                            <div class="metric-card">
                                <h3>50+</h3>
                                <p class="mb-0">Branches</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="metric-card">
                                <h3>5</h3>
                                <p class="mb-0">Major Banks</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="metric-card">
                                <h3>Baku</h3>
                                <p class="mb-0">Coverage</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Banking Services Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">
                <i class="bi bi-gear me-2"></i>
                Available Banking Services
            </h3>
            
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="feature-card text-center h-100">
                        <div class="card-body">
                            <i class="bi bi-credit-card display-4 text-primary mb-3"></i>
                            <h5>ATM Services</h5>
                            <p class="text-muted">24/7 cash withdrawal, balance inquiry, and mini statements</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="feature-card text-center h-100">
                        <div class="card-body">
                            <i class="bi bi-currency-exchange display-4 text-success mb-3"></i>
                            <h5>Currency Exchange</h5>
                            <p class="text-muted">Foreign exchange services for major currencies</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="feature-card text-center h-100">
                        <div class="card-body">
                            <i class="bi bi-people display-4 text-info mb-3"></i>
                            <h5>Personal Banking</h5>
                            <p class="text-muted">Savings accounts, loans, and financial planning</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="feature-card text-center h-100">
                        <div class="card-body">
                            <i class="bi bi-building display-4 text-warning mb-3"></i>
                            <h5>Business Banking</h5>
                            <p class="text-muted">Corporate accounts, trade finance, and business loans</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Branch Types Information -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="getting-started-section">
                <h3 class="text-center mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    Types of Bank Branches
                </h3>
                
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="text-center">
                            <div class="step-number bg-primary text-white d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-building"></i>
                            </div>
                            <h5>Main Branches</h5>
                            <p class="text-muted">
                                Full-service branches offering all banking products and services. 
                                Typically have longer hours and specialized staff.
                            </p>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-4">
                        <div class="text-center">
                            <div class="step-number bg-success text-white d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-shop"></i>
                            </div>
                            <h5>Sub-Branches</h5>
                            <p class="text-muted">
                                Smaller branches focusing on essential banking services. 
                                Convenient locations for everyday banking needs.
                            </p>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-4">
                        <div class="text-center">
                            <div class="step-number bg-info text-white d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-credit-card"></i>
                            </div>
                            <h5>ATM Locations</h5>
                            <p class="text-muted">
                                24/7 automated teller machines for cash withdrawals, 
                                deposits, and account inquiries.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="row mt-5">
        <div class="col-lg-6">
            <div class="feature-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-question-circle me-2"></i>
                        Need Directions?
                    </h5>
                    <p class="card-text">
                        Click on any branch marker on the map to see detailed information 
                        and get directions using your preferred navigation app.
                    </p>
                    <div class="d-flex gap-2">
                        <a href="https://maps.google.com" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-geo-alt me-1"></i>Google Maps
                        </a>
                        <a href="https://yandex.com/maps" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-geo-alt me-1"></i>Yandex Maps
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="feature-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-chat-dots me-2"></i>
                        Ask About Banking Services
                    </h5>
                    <p class="card-text">
                        Our AI assistant can help you find specific banking services, 
                        operating hours, and answer questions about bank locations.
                    </p>
                    <a href="/chat" class="btn btn-primary">
                        <i class="bi bi-chat-dots me-2"></i>
                        Chat with AI Assistant
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Permission Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-geo-alt me-2"></i>
                    Location Access
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>To provide you with the most accurate branch locations, we'd like to access your current location.</p>
                <p class="text-muted small">Your location data is only used to find nearby branches and is not stored or shared.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Use Default Location</button>
                <button type="button" class="btn btn-primary" onclick="requestLocation()">Allow Location Access</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables for branch finder
    let branchMap;
    let branchMarkers = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeBranchMap();
    });
    
    function initializeBranchMap() {
        // Initialize the map
        branchMap = L.map('branchMap').setView([40.4093, 49.8671], 12);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(branchMap);
        
        // Add user location marker
        const userIcon = L.divIcon({
            html: '<i class="bi bi-geo-alt-fill text-danger" style="font-size: 24px;"></i>',
            className: 'custom-div-icon',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
        });
        
        const userMarker = L.marker([40.4093, 49.8671], {icon: userIcon})
            .addTo(branchMap)
            .bindPopup('<strong>Your Location</strong><br>Baku, Azerbaijan');
    }
    
    function setLocation(lat, lng, name) {
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        
        // Update map view
        branchMap.setView([lat, lng], 13);
        
        showAlert('success', `Location set to ${name}`);
    }
    
    function requestLocation() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
        modal.hide();
        
        if (navigator.geolocation) {
            showLoading('Getting your location...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lng.toFixed(6);
                    
                    branchMap.setView([lat, lng], 13);
                    
                    hideLoading();
                    showAlert('success', 'Location updated successfully!');
                },
                function(error) {
                    hideLoading();
                    showAlert('warning', 'Unable to get your location. Using default location (Baku).');
                    console.error('Geolocation error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        } else {
            showAlert('error', 'Geolocation is not supported by this browser.');
        }
    }
    
    // Override the global focusOnBranch function for this page
    window.focusOnBranch = function(lat, lng) {
        branchMap.setView([lat, lng], 16);
        
        // Highlight the marker temporarily
        branchMap.eachLayer(function(layer) {
            if (layer instanceof L.Marker && 
                layer.getLatLng().lat.toFixed(6) == lat.toFixed(6) && 
                layer.getLatLng().lng.toFixed(6) == lng.toFixed(6)) {
                layer.openPopup();
            }
        });
    };
    
    // Enhanced branch display function
    function displayBranchResults(results, map) {
        const container = document.getElementById('branchResults');
        if (!container) return;
        
        // Clear existing markers (keep user location marker)
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker && !layer.options.isUserLocation) {
                map.removeLayer(layer);
            }
        });
        
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3>Found ${results.showing} branches nearby</h3>
                    <p class="text-muted mb-0">Within ${Math.max(...results.branches.map(b => b.distance_km))} km radius</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportResults()">
                        <i class="bi bi-download me-1"></i>Export List
                    </button>
                </div>
            </div>
        `;
        
        // Create branch markers and cards
        results.branches.forEach((branch, index) => {
            // Create custom marker icon based on bank
            const bankColors = {
                'PASHA Bank': '#1f4e79',
                'Kapital Bank': '#27ae60',
                'International Bank': '#e74c3c',
                'AccessBank': '#3498db',
                'RabiteBank': '#f39c12'
            };
            
            const color = bankColors[branch.bank_name] || '#6c757d';
            
            const branchIcon = L.divIcon({
                html: `<div style="background-color: ${color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="bi bi-bank" style="font-size: 12px;"></i></div>`,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([branch.coordinates.lat, branch.coordinates.lng], {icon: branchIcon})
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <strong>${branch.bank_name}</strong><br>
                        <strong>${branch.branch_name}</strong><br>
                        <small class="text-muted">${branch.address}</small><br>
                        <div class="mt-2">
                            <strong>${branch.distance_km} km away</strong><br>
                            <small><i class="bi bi-clock"></i> ${branch.hours}</small><br>
                            <small><i class="bi bi-telephone"></i> ${branch.phone}</small>
                        </div>
                        <div class="mt-2">
                            <a href="tel:${branch.phone}" class="btn btn-primary btn-sm">
                                <i class="bi bi-telephone"></i> Call
                            </a>
                            <a href="https://maps.google.com/maps?q=${branch.coordinates.lat},${branch.coordinates.lng}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-map"></i> Directions
                            </a>
                        </div>
                    </div>
                `);
            
            // Branch card HTML
            html += `
                <div class="col-12 mb-3">
                    <div class="branch-card slide-up" style="animation-delay: ${index * 0.1}s">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="mb-1" style="color: ${color};">${branch.bank_name}</h5>
                                        <h6 class="text-dark mb-2">${branch.branch_name}</h6>
                                    </div>
                                    <span class="badge bg-success fs-6">${branch.distance_km} km</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    ${branch.address}
                                </p>
                                <div class="row text-sm">
                                    <div class="col-sm-6">
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>
                                            ${branch.hours}
                                        </small>
                                    </div>
                                    <div class="col-sm-6">
                                        <small class="text-muted">
                                            <i class="bi bi-telephone me-1"></i>
                                            ${branch.phone}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="focusOnBranch(${branch.coordinates.lat}, ${branch.coordinates.lng})">
                                        <i class="bi bi-geo-alt me-1"></i>View on Map
                                    </button>
                                    <div class="btn-group" role="group">
                                        <a href="tel:${branch.phone}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-telephone"></i>
                                        </a>
                                        <a href="https://maps.google.com/maps?q=${branch.coordinates.lat},${branch.coordinates.lng}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-map"></i>
                                        </a>
                                        <a href="https://yandex.com/maps/?ll=${branch.coordinates.lng},${branch.coordinates.lat}&z=16" target="_blank" class="btn btn-outline-info btn-sm">
                                            <i class="bi bi-compass"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Fit map to show all branches
        if (results.branches.length > 0) {
            const group = new L.featureGroup();
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    group.addLayer(layer);
                }
            });
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
    
    function exportResults() {
        // Simple CSV export functionality
        const branches = Array.from(document.querySelectorAll('.branch-card')).map(card => {
            const bankName = card.querySelector('h5').textContent;
            const branchName = card.querySelector('h6').textContent;
            const address = card.querySelector('.text-muted').textContent.replace('🗺️', '').trim();
            return `"${bankName}","${branchName}","${address}"`;
        });
        
        const csv = 'Bank Name,Branch Name,Address\n' + branches.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bank_branches.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}